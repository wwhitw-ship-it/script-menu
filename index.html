<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»é¡Œé¸å–® & é€²åº¦è¿½è¹¤ | ç¤¾ç¾¤å½±éŸ³æ²™é¾</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .card-selected { border-color: #3b82f6; background-color: #eff6ff; }
        .card-selected .check-icon { background-color: #3b82f6; border-color: #3b82f6; color: white; }

        .tag-è®¤çŸ¥ { background-color: #dbeafe; color: #1e40af; }
        .tag-è€ƒæ…® { background-color: #fef3c7; color: #92400e; }
        .tag-è½‰æ› { background-color: #fee2e2; color: #991b1b; }

        /* é€²åº¦ç‹€æ…‹é¡è‰² */
        .status-script { background-color: #e0e7ff; color: #4338ca; border: 1px solid #c7d2fe; }
        .status-edit { background-color: #ffedd5; color: #c2410c; border: 1px solid #fed7aa; }
        .status-done { background-color: #dcfce7; color: #15803d; border: 1px solid #86efac; }
        
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .tab-active { border-bottom: 2px solid #3b82f6; color: #2563eb; font-weight: 700; }
        .tab-inactive { color: #6b7280; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 pb-32">

    <!-- Loading -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-gray-500 text-sm font-medium">è³‡æ–™åŒæ­¥ä¸­...</p>
    </div>

    <!-- é–€ç¦ç•«é¢ (Access Gate) -->
    <div id="access-gate" class="fixed inset-0 bg-gray-50 z-50 flex flex-col items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full text-center border border-gray-100">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-lock text-blue-600 text-2xl"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">è«‹ä½¿ç”¨å°ˆå±¬é€£çµ</h2>
            <p class="text-gray-500 text-sm mb-8 leading-relaxed">
                æ‚¨ç›®å‰ä½æ–¼å…¬é–‹å…¥å£ã€‚<br>
                è«‹é»æ“Šæ‚¨çš„å°ˆå±¬é€£çµä»¥æŸ¥çœ‹å…§å®¹ã€‚
            </p>
            
            <div class="border-t border-gray-100 pt-6">
                <!-- åˆå§‹æŒ‰éˆ• -->
                <button id="admin-login-btn" onclick="showLoginInput()" class="text-xs text-gray-400 hover:text-gray-600 transition flex items-center justify-center mx-auto gap-1">
                    <i class="fa-solid fa-user-shield"></i> ç®¡ç†å“¡ç™»å…¥
                </button>

                <!-- å¯†ç¢¼è¼¸å…¥å€ (é è¨­éš±è—) -->
                <div id="admin-input-area" class="hidden animate-fade-in">
                    <div class="flex items-center gap-2">
                        <input type="password" id="admin-pass" placeholder="è¼¸å…¥é€šè¡Œç¢¼ (8888)" class="flex-1 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                        <button onclick="submitAdminLogin()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition">
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                    <p id="login-error" class="text-red-500 text-xs mt-2 hidden">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦</p>
                </div>
            </div>
        </div>
    </div>

    <!-- é ‚éƒ¨å°èˆª -->
    <div id="main-nav" class="fixed top-0 left-0 right-0 bg-white shadow-sm z-50">
        <div class="max-w-3xl mx-auto px-4 pt-3">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-xl font-bold text-gray-900 tracking-tight flex items-center">
                    <i class="fa-solid fa-layer-group text-blue-600 mr-2"></i>
                    <span id="header-title">å°ˆæ¡ˆå„€è¡¨æ¿</span>
                </h1>
                <span id="status-badge" class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full flex items-center">
                    <span class="w-2 h-2 rounded-full bg-gray-400 mr-1"></span> è®€å–ä¸­
                </span>
            </div>

            <!-- å®¢æˆ¶ç¯©é¸ (åªæœ‰ Admin æ¨¡å¼é¡¯ç¤º) -->
            <div class="flex items-center space-x-2 pb-2 mb-1" id="filter-container">
                <span class="text-xs font-bold text-gray-400 whitespace-nowrap mr-1"><i class="fa-solid fa-filter mr-1"></i>å®¢æˆ¶:</span>
                <div class="relative flex-1 max-w-xs">
                    <select id="client-select" onchange="filterClient(this.value)" class="appearance-none w-full bg-gray-100 text-gray-700 text-sm border border-gray-200 rounded-lg px-3 py-1.5 pr-8 focus:outline-none focus:bg-white focus:border-blue-500 cursor-pointer font-medium transition-colors">
                        <option value="all">é¡¯ç¤ºå…¨éƒ¨å®¢æˆ¶</option>
                        <!-- é¸é …å°‡ç”± JS è‡ªå‹•ç”Ÿæˆ -->
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <!-- é ç±¤ -->
            <div class="flex border-b border-gray-200 mt-1">
                <button onclick="switchTab('select')" id="tab-select" class="flex-1 pb-2 text-center text-sm tab-active transition-colors">
                    æˆ‘è¦é¸é¡Œ <span id="count-select" class="ml-1 bg-gray-100 text-gray-600 text-[10px] px-1.5 py-0.5 rounded-full">0</span>
                </button>
                <button onclick="switchTab('progress')" id="tab-progress" class="flex-1 pb-2 text-center text-sm tab-inactive transition-colors">
                    è£½ä½œé€²åº¦ <span id="count-progress" class="ml-1 bg-blue-100 text-blue-600 text-[10px] px-1.5 py-0.5 rounded-full">0</span>
                </button>
            </div>
        </div>
    </div>

    <!-- æ­¡è¿è©å€å¡Š -->
    <div id="welcome-banner" class="max-w-3xl mx-auto px-4 mt-36 mb-4 hidden">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-lg p-4 text-white shadow-md relative overflow-hidden">
            <div class="relative z-10">
                <h2 class="font-bold text-lg mb-1">Hi, <span id="client-name-display"></span></h2>
                <p id="banner-desc" class="text-blue-100 text-sm opacity-90">ä¸‹æ–¹æ˜¯æ‚¨çš„é¸é¡Œæ¸…å–®èˆ‡ç›®å‰å°ˆæ¡ˆé€²åº¦ã€‚</p>
                <!-- åªæœ‰ Admin æ¨¡å¼é¡¯ç¤ºæ­¤æŒ‰éˆ• -->
                <button id="share-link-btn" onclick="copyClientLink()" class="mt-3 text-xs bg-white/20 hover:bg-white/30 text-white border border-white/40 px-3 py-1.5 rounded-full flex items-center transition-colors hidden">
                    <i class="fa-solid fa-link mr-1.5"></i> è¤‡è£½å°ˆå±¬é€£çµ
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <div class="max-w-3xl mx-auto px-4 mt-36 transition-all duration-300" id="card-container"></div>

    <!-- ç©ºç‹€æ…‹ -->
    <div id="empty-state" class="hidden text-center mt-20 px-6">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
            <i class="fa-solid fa-box-open text-gray-400 text-2xl"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900">æ­¤å€å¡Šæ²’æœ‰è³‡æ–™</h3>
        <p class="text-gray-500 mt-2">å¤ªæ£’äº†ï¼ç›®å‰æ‰€æœ‰å·¥ä½œéƒ½å·²å®Œæˆæˆ–å°šæœªå»ºç«‹ã€‚</p>
    </div>

    <!-- åº•éƒ¨æ“ä½œå€ -->
    <div id="action-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] hidden">
        <div class="max-w-3xl mx-auto flex items-center justify-between gap-4">
            <div class="flex flex-col">
                <span class="text-xs text-gray-500">å·²å‹¾é¸</span>
                <div class="flex items-baseline">
                    <span id="selected-count" class="text-2xl font-bold text-blue-600 font-mono">0</span>
                    <span class="text-sm text-gray-600 ml-1">å€‹</span>
                </div>
            </div>
            <button onclick="submitSelection()" id="submit-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform active:scale-95 transition-all flex items-center justify-center">
                <i class="fa-regular fa-paper-plane mr-2"></i> é€å‡ºé¸é¡Œ
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl opacity-0 pointer-events-none transition-opacity duration-300 z-[60]"></div>

    <script>
        // ==========================================
        // CONFIG: Apps Script ç¶²å€
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbyUX0mGciBasmG0CpADuFxCecBUAM0gYF4MtIsCTNu-99Us4SNPzh0LLAlAuQ2hrK4w/exec"; 

        let database = [];
        let selectedIds = new Set();
        let currentClientFilter = 'all';
        let isAdminMode = false;
        let currentTab = 'select';

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const clientParam = urlParams.get('client');
            const modeParam = urlParams.get('mode');

            if (clientParam) {
                // --- å®¢æˆ¶æ¨¡å¼ ---
                await fetchData();
                isAdminMode = false;
                filterClient(clientParam);
                document.getElementById('filter-container').style.display = 'none'; // éš±è—ç¯©é¸å™¨
                adjustLayoutForClient();
            } else if (modeParam === 'admin') {
                // --- ç®¡ç†å“¡æ¨¡å¼ (ç¶²å€é€²å…¥) ---
                await fetchData();
                isAdminMode = true;
                generateClientOptions(); 
                renderCards();
            } else {
                // --- é–€ç¦æ¨¡å¼ ---
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('access-gate').classList.remove('hidden');
                document.getElementById('main-nav').style.display = 'none';
            }
        });

        function adjustLayoutForClient() {
            document.getElementById('welcome-banner').classList.remove('mt-36');
            document.getElementById('welcome-banner').classList.add('mt-32');
            const navPt3 = document.getElementById('main-nav').querySelector('.pt-3');
            if(navPt3) {
                navPt3.classList.remove('pt-3');
                navPt3.classList.add('pt-4');
            }
        }

        // --- æ–°çš„ç™»å…¥ UI é‚è¼¯ ---
        function showLoginInput() {
            document.getElementById('admin-login-btn').classList.add('hidden');
            document.getElementById('admin-input-area').classList.remove('hidden');
            document.getElementById('admin-pass').focus();
        }

        async function submitAdminLogin() {
            const input = document.getElementById('admin-pass');
            const errorMsg = document.getElementById('login-error');
            const pass = input.value;

            if (pass === "8888") {
                // ç™»å…¥æˆåŠŸ
                errorMsg.classList.add('hidden');
                document.getElementById('access-gate').classList.add('hidden');
                document.getElementById('main-nav').style.display = 'block';
                document.getElementById('loading-overlay').style.display = 'flex';
                
                isAdminMode = true;
                await fetchData();
                generateClientOptions();
                renderCards();
            } else {
                // ç™»å…¥å¤±æ•—
                errorMsg.classList.remove('hidden');
                input.value = "";
                input.focus();
            }
        }
        
        // æ”¯æ´æŒ‰ Enter éµç™»å…¥
        document.getElementById('admin-pass')?.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') submitAdminLogin();
        });

        async function fetchData() {
            try {
                if(API_URL.includes("è«‹æŠŠä½ çš„")) throw new Error("API URLå°šæœªè¨­å®š");
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Network response');
                database = await response.json();
                updateStatus(true);
            } catch (error) {
                console.warn("ä½¿ç”¨æ¼”ç¤ºè³‡æ–™æ¨¡å¼", error);
                useFallbackData();
                updateStatus(false);
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        function generateClientOptions() {
            const select = document.getElementById('client-select');
            const clients = [...new Set(database.map(item => item.client).filter(c => c))];
            
            select.innerHTML = '<option value="all">é¡¯ç¤ºå…¨éƒ¨å®¢æˆ¶</option>';
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                option.innerText = client;
                select.appendChild(option);
            });
        }

        function switchTab(tabName) {
            currentTab = tabName;
            const tabs = ['select', 'progress'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (t === tabName) {
                    btn.classList.add('tab-active', 'text-blue-600');
                    btn.classList.remove('tab-inactive', 'text-gray-500');
                } else {
                    btn.classList.remove('tab-active', 'text-blue-600');
                    btn.classList.add('tab-inactive', 'text-gray-500');
                }
            });
            const actionBar = document.getElementById('action-bar');
            if (tabName === 'select') {
                actionBar.classList.remove('hidden');
                document.body.classList.add('pb-32');
            } else {
                actionBar.classList.add('hidden');
                document.body.classList.remove('pb-32');
            }
            renderCards();
        }

        function renderCards() {
            const container = document.getElementById('card-container');
            const emptyState = document.getElementById('empty-state');
            const welcomeBanner = document.getElementById('welcome-banner');
            const shareBtn = document.getElementById('share-link-btn');
            
            container.innerHTML = '';

            let clientData = database.filter(item => {
                if (currentClientFilter === 'all') return true;
                return item.client === currentClientFilter;
            });

            const selectData = clientData.filter(item => 
                (!item.status || item.status === 'æœªé¸æ“‡') && item.userSelected !== 'é¸åˆ°äº†'
            );
            
            const progressData = clientData.filter(item => 
                (item.status && item.status !== 'æœªé¸æ“‡') || item.userSelected === 'é¸åˆ°äº†'
            );

            document.getElementById('count-select').innerText = selectData.length;
            document.getElementById('count-progress').innerText = progressData.length;

            const filteredData = currentTab === 'select' ? selectData : progressData;

            if (currentClientFilter !== 'all') {
                welcomeBanner.classList.remove('hidden');
                document.getElementById('client-name-display').innerText = currentClientFilter;
                if (isAdminMode) shareBtn.classList.remove('hidden'); else shareBtn.classList.add('hidden');
            } else {
                welcomeBanner.classList.add('hidden');
            }

            if (filteredData.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            filteredData.forEach(item => {
                const isSelected = selectedIds.has(item.id);
                let statusBadge = '';
                let actionButtons = '';
                
                if (currentTab === 'progress') {
                    let status = item.status;
                    if (!status && item.userSelected === 'é¸åˆ°äº†') status = 'ç­‰å¾…å®‰æ’';
                    
                    let statusClass = 'bg-gray-100 text-gray-600 border-gray-200';
                    if(status.includes('è…³æœ¬')) statusClass = 'status-script';
                    if(status.includes('å‰ªè¼¯') || status.includes('æ‹æ”')) statusClass = 'status-edit';
                    if(status.includes('å®Œæˆ')) statusClass = 'status-done';
                    if(status === 'ç­‰å¾…å®‰æ’') statusClass = 'bg-gray-100 text-gray-500 border-dashed border-gray-300';

                    statusBadge = `<span class="px-2 py-0.5 rounded text-xs font-bold border ${statusClass}">${status}</span>`;

                    const outlineContent = item.outline ? item.outline : '<span class="text-gray-400 italic">ï¼ˆç›®å‰å°šç„¡å¤§ç¶±å…§å®¹ï¼‰</span>';
                    actionButtons += `
                        <div class="w-full mt-3 p-3 bg-indigo-50 rounded-lg text-sm text-gray-700 border border-indigo-100">
                            <div class="font-bold text-xs text-indigo-500 mb-1"><i class="fa-solid fa-list-ul mr-1"></i> è…³æœ¬å¤§ç¶±ï¼š</div>
                            <div class="whitespace-pre-wrap">${outlineContent}</div>
                        </div>
                    `;

                    if (item.videoUrl) {
                        actionButtons += `
                            <div class="w-full mt-2">
                                <div class="font-bold text-xs text-gray-400 mb-1 mt-2">å®Œæˆæª”æ¡ˆï¼š</div>
                                <a href="${item.videoUrl}" target="_blank" class="block w-full bg-gray-800 hover:bg-black text-white text-sm font-medium py-2 px-3 rounded-lg text-center transition">
                                    <i class="fa-solid fa-play mr-2"></i> é»æ“Šè§€çœ‹å½±ç‰‡
                                </a>
                            </div>
                        `;
                    } else {
                        actionButtons += `
                            <div class="w-full mt-2">
                                <div class="font-bold text-xs text-gray-400 mb-1 mt-2">å®Œæˆæª”æ¡ˆï¼š</div>
                                <button disabled class="block w-full bg-gray-100 text-gray-400 text-sm font-medium py-2 px-3 rounded-lg text-center cursor-not-allowed">
                                    <i class="fa-solid fa-video-slash mr-2"></i> å°šç„¡å½±ç‰‡é€£çµ
                                </button>
                            </div>
                        `;
                    }

                    const captionContent = item.caption ? item.caption : '<span class="text-gray-400 italic">ï¼ˆç›®å‰å°šç„¡æ–‡æ¡ˆï¼‰</span>';
                    actionButtons += `
                        <div class="w-full mt-3 mb-2 p-3 bg-gray-50 rounded-lg text-sm text-gray-700 border border-gray-200 relative group">
                            <div class="font-bold text-xs text-gray-400 mb-1">è²¼æ–‡æ–‡æ¡ˆï¼š</div>
                            <div class="whitespace-pre-wrap select-all">${captionContent}</div>
                        </div>
                    `;
                    
                    if (item.caption) {
                        actionButtons += `
                            <button onclick="copyCaption('${item.id}')" class="w-full bg-blue-50 hover:bg-blue-100 text-blue-600 text-sm font-medium py-2 px-3 rounded-lg flex items-center justify-center transition border border-blue-200">
                                <i class="fa-regular fa-copy mr-2"></i> è¤‡è£½æ–‡æ¡ˆ
                            </button>
                        `;
                    }
                }

                let phaseClass = 'bg-gray-100 text-gray-600';
                if (item.phase === 'èªçŸ¥') phaseClass = 'tag-è®¤çŸ¥';
                if (item.phase === 'è€ƒæ…®') phaseClass = 'tag-è€ƒæ…®';
                if (item.phase === 'è½‰æ›') phaseClass = 'tag-è½‰æ›';

                const clickableClass = currentTab === 'select' ? 'cursor-pointer hover:shadow-md' : '';
                const clickAction = currentTab === 'select' ? `onclick="toggleCard('${item.id}')"` : '';
                const selectedClass = (currentTab === 'select' && isSelected) ? 'card-selected' : 'border-white';
                
                const checkboxHTML = currentTab === 'select' ? `
                    <div class="absolute top-5 right-5 w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center transition-colors check-icon ${isSelected ? 'bg-blue-600 border-blue-600 text-white' : 'bg-white'}">
                        <i class="fa-solid fa-check text-xs ${isSelected ? '' : 'hidden'}"></i>
                    </div>` : `<div class="absolute top-5 right-5">${statusBadge}</div>`;

                const cardHTML = `
                    <div ${clickAction} class="card-item group relative bg-white rounded-xl p-5 mb-4 border-2 border-transparent transition-all duration-200 shadow-sm ${clickableClass} ${selectedClass}">
                        ${checkboxHTML}
                        <div class="flex flex-wrap gap-2 mb-3 pr-16">
                            <span class="px-2 py-0.5 rounded text-xs font-bold ${phaseClass}">${item.phase}</span>
                            <span class="px-2 py-0.5 rounded text-xs bg-gray-100 text-gray-500 border border-gray-200">#${item.type}</span>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2 leading-snug">
                            <span class="text-gray-400 text-sm font-normal mr-1 select-none">#${item.id}</span>
                            ${item.title}
                        </h3>
                        
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-100 mb-3">
                            <span class="font-bold text-gray-400 block mb-1 text-xs"><i class="fa-regular fa-lightbulb mr-1"></i>é‡é»èªªæ˜ï¼š</span>
                            <div class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">${item.desc || '<span class="text-gray-400 italic">ï¼ˆç„¡èªªæ˜ï¼‰</span>'}</div>
                        </div>

                        ${currentTab === 'progress' ? `<div class="mt-4 pt-3 border-t border-gray-100">${actionButtons}</div>` : ''}
                    </div>
                `;
                container.innerHTML += cardHTML;
            });
        }

        function toggleCard(id) {
            if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
            updateUI();
        }

        function updateUI() {
            document.getElementById('selected-count').innerText = selectedIds.size;
            renderCards(); 
        }

        function filterClient(clientName) {
            currentClientFilter = clientName;
            // æ›´æ–°ä¸‹æ‹‰é¸å–®çš„é¡¯ç¤ºå€¼ (å¦‚æœæ˜¯ç”±ä»£ç¢¼è§¸ç™¼çš„è®Šæ›´)
            if (isAdminMode) {
                const select = document.getElementById('client-select');
                if(select) select.value = clientName;
            }
            selectedIds.clear();
            document.getElementById('selected-count').innerText = '0';
            renderCards();
        }

        async function submitSelection() {
            if (selectedIds.size === 0) { showToast("âš ï¸ è«‹å…ˆå‹¾é¸ä¸»é¡Œ", "bg-red-500"); return; }
            
            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> è™•ç†ä¸­...`;
            btn.disabled = true;

            try {
                const payload = { ids: Array.from(selectedIds) };
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });

                showToast("âœ… é¸é¡ŒæˆåŠŸï¼å¾Œå°å·²æ›´æ–°", "bg-green-600");
                
                database.forEach(item => {
                    if (selectedIds.has(item.id)) {
                        item.userSelected = 'é¸åˆ°äº†';
                    }
                });
                
                selectedIds.clear();
                updateUI();
                setTimeout(() => { switchTab('progress'); }, 1500);

            } catch (error) {
                console.error(error);
                showToast("âŒ é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦", "bg-red-500");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function copyCaption(id) {
            const item = database.find(i => i.id === id);
            if(item && item.caption) {
                copyToClipboard(item.caption, "ğŸ“‹ æ–‡æ¡ˆå·²è¤‡è£½ï¼");
            }
        }

        function copyClientLink() {
            if (currentClientFilter === 'all') return;
            const baseUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            copyToClipboard(`${baseUrl}?client=${currentClientFilter}`, "ğŸ”— å°ˆå±¬é€£çµå·²è¤‡è£½ï¼");
        }

        function copyToClipboard(text, msg = "å·²è¤‡è£½ï¼") {
            navigator.clipboard.writeText(text).then(() => {
                showToast(`<i class="fa-solid fa-check-circle mr-2"></i> ${msg}`, "bg-gray-800");
            }).catch(err => alert('è¤‡è£½å¤±æ•—'));
        }

        function showToast(html, bgClass = "bg-gray-800") {
            const toast = document.getElementById('toast');
            toast.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white px-6 py-3 rounded-lg shadow-xl z-[60] transition-opacity duration-300 ${bgClass}`;
            toast.innerHTML = html;
            toast.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => { toast.classList.add('opacity-0', 'pointer-events-none'); }, 2000);
        }

        function updateStatus(isOnline) {
            const badge = document.getElementById('status-badge');
            if(isOnline) {
                badge.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500 mr-1"></span> å·²é€£ç·š`;
                badge.className = "text-xs bg-green-50 text-green-700 px-2 py-1 rounded-full flex items-center border border-green-200";
            } else {
                badge.innerHTML = `<span class="w-2 h-2 rounded-full bg-orange-400 mr-1"></span> æ¼”ç¤ºæ¨¡å¼`;
                badge.className = "text-xs bg-orange-50 text-orange-700 px-2 py-1 rounded-full flex items-center border border-orange-200";
            }
        }

        function useFallbackData() {
            database = [
                { id: "Demo-1", client: "æ¼”ç¤ºå®¢æˆ¶", phase: "èªçŸ¥", type: "ç¤ºç¯„", title: "è«‹æª¢æŸ¥ GAS éƒ¨ç½²æ¬Šé™", desc: "è«‹ç¢ºèª Google Apps Script éƒ¨ç½²èº«åˆ†ç‚ºã€ä»»ä½•äººã€(Anyone)", status: "æœªé¸æ“‡" },
                { id: "Demo-2", client: "æ¼”ç¤ºå®¢æˆ¶", phase: "è½‰æ›", type: "ç¤ºç¯„", title: "ç¯„ä¾‹ï¼šå·²å®Œæˆå½±ç‰‡", desc: "é€™æ˜¯é€²åº¦ç¯„ä¾‹", status: "å·²å®Œæˆ", caption: "é€™æ˜¯ä¸€æ®µæ¸¬è©¦æ–‡æ¡ˆï¼Œä½ å¯ä»¥ç›´æ¥çœ‹åˆ°æˆ‘ï¼\nè¦ºå¾—ä¸éŒ¯å°±æŒ‰ä¸‹é¢è¤‡è£½å§ã€‚", videoUrl: "#", outline: "1. é–‹å ´\n2. é‡é»\n3. çµå°¾" }
            ];
        }
    </script>
</body>
</html>
